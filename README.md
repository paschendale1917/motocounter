###	Счетчик моточасов с системой меню и управлением с помощью трехпозиционного слайдера

- **Микроконтроллер:** STM32G030F6P6 
- **Частота:** 64 МГц
- **IDE:** Keil uVision
- **Compiler:** v6.19
- **Язык:** C (Embedded)
- **Дисплей:** LCD ST7735 0.96" 80_160(IPS), 1.8" 128_160(TN), 0.85" 128_128(IPS)
- **Задействованная периферия:** таймеры, АЦП, spi, i2c, DMA
- **Управление:** Трехпозиционная кнопка(слайдер)
- **Программатор:** ST-Link v2

###	Больше по дисплею
- можно любой на ST7735, но в дефайнах изменить разрешение, а также параметры LCD_HEIGHT_OFFSET и LCD_WIDTH_OFFSET выставить на 0, либо подобрать свои смещения
- возможно придется поиграться с регистрами MADCTL и INVON/INVOFF дисплея для установки верной ориентации и режима отображения цветов

###	Больше по периферии
- Нажатия слайдера обрабатываются в прерываниях таймера TIM1. Распознанютсдлительные и короткие нажатия.
- Подсветка дисплея использует таймер TIM14  в режиме ШИМ.
- Баззер использует таймер TIM17 в режиме ШИМ.
- Счетчик организован на таймере TIM16.
- Светодиоды WS2812 используют таймер TIM3 и канал 1 DMA1
- Вольтметр использует канал 10 мультиплексора АЦП и канал 2 DMA1
- Дисплей на SPI1
- EEPROM на I2C2

###	Клонирование репозитория
git clone https://github.com/paschendale1917/motocounter.git

###	Принцип работы:
После подачи питания устройство считывает из EEPROM настроечные константы, измеряет напряжение в бортовой сети и отображает на главном экране
 количество наработанных моточасов,напряжение бортовой сети и уставку моточасов, при достижении значения которой счетчик будет подавать светозвуковой сигнал.
При заведенном двигателе напряжение в бортовой сети повышается и при достижении порогового значения начинается отсчет времени.
Из меню можно настроить:
-величину порогового значения напряжения в бортовой сети для старта отсчета времени наработки
-уставку моточасов для подачи светозвуковой сигнализации при ее превышении счетчиком ее значения
-величину значения делителя(для того, чтобы не разбирать и не подстраивать потенциометр на входе АЦП)
При снижении напряжения питания ниже порогового значения прекращается отсчет времени и производится запись значения счетчика в EEPROM.
Все остальные настраиваемые константы также сохраняются в EEPROM.
Для того, чтобы при резком отключении питания была возможность сохранения всех настроек и значения счетчика, на входе по питанию установлены 2 конденсатора по 1000 мкФ. 
 
###	Управление:
- вход в меню из главного экрана по длительному нажатию на центр слайдера
- выход из меню на скрисейвер по длительному отклонению слайдера влево
- вход в дочернее меню (child) по короткому нажатию на на центр слайдера
- выход в родительское меню (parent) по длительному отклонению слайдера влево
- вход в обработчик пункта меню по короткому нажатию на на центр слайдера
- выход из обработчика пункта меню по длительному отклонению слайдера влево
- согласие на системный ресет или сброс счетчика моточасов по длительному отклонению слайдера вправо

###	Краткое описание системы меню:
- Создана структура, в которой описаны связи пунктов меню(двунаправленные связные списки)между друг другом и обработчиками состояния меню(попытка в КА).
- В бесконечном цикле мониторится состояние переменной menustate(состояние меню),состояние флагов органов управления, отслеживаются изменения в состоянии меню,которое перерисовывается в соответствии с этими изменениями. 
	Также здесь работает функция display_pointer(pointer), которая меняет положение указателя в соответствии с активным пунктом меню(всегда указывает на него). Координаты указателя явно заданы в структуре. 
	Всё это происходит до того момента, пока переменная menustate не примет значение, соответствующее номеру одного из обработчиков.
- Как только зафиксировано изменение в состоянии органов управления(нажатие кнопки или вращение вала энкодера), то происходит действие в соответствии с заданным функционалом в process_menu() и связями, установленными 
	в структуре пункта меню- это либо вход в обработчик, либо в дочернее меню(кнопка), либо перемещение по меню(вал).
- При входе в обработчик в переменную menustate записывается его номер и таким образом process_menu() передает ему управление. Далее программа действует в соответствии с внутренней логикой обработчика.
- При выходе из обработчика в переменную menustate записывается значение, не соответствующее ни одному из номеров обработчиков, что возвращает управление функции process_menu().
- При старте в переменной menustate записан 0, что соответствует обработчику скринсейвера.
 
###	Внимание!
- Уверенно измеряет напряжение от 7 до 22 вольт, чтобы изменить диапазон, требуется подобрать иную элементную базу.
- Нужно помнить, что чем выше входное напряжение, тем выше нагрев(78M05), поэтому беспроблемная эксплуатация возможна только на легковом 
 автомобиле с номинальным напряжением бортовой сети 12 в

###	TO DO:
- Настройка цвета индикации превышения уставки моточасов
- Отключение дисплея и его подсветки при длительном отсутствии активности
- Watchdog

